<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙŠÙˆÙ…ÙŠØ§Øª Ø¥ÙŠÙ‡Ø§Ø¨ - Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ Ø§Ù„Ù…Ø·ÙˆØ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© Ø¬Ù…ÙŠÙ„Ø© -->
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;600;800&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --book-w: 800px;
            --book-h: 550px;
            --paper-bg: #fffbf2; 
            --primary: #00897b;   
            --secondary: #ff7043; 
            --accent: #ffd54f;    
            --text-main: #37474f; 
            --font-main: 'Baloo Bhaijaan 2', 'Tajawal', sans-serif;
        }

        body {
            background-color: #b2dfdb; 
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: var(--font-main);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; 
        }

        .stage {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            perspective: 2500px; z-index: 10; position: relative;
        }

        .book {
            position: relative;
            width: var(--book-w);
            height: var(--book-h);
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.25, 1, 0.5, 1);
            transform: rotateX(20deg); 
            box-shadow: 0 50px 70px rgba(0,0,0,0.3), 0 10px 20px rgba(0,0,0,0.1); 
        }

        .page {
            position: absolute;
            width: 50%; height: 100%;
            top: 0; right: 0; 
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1);
            background-color: var(--paper-bg);
            border-radius: 0 15px 15px 0;
            cursor: pointer;
        }

        .front, .back {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            backface-visibility: hidden; overflow: hidden;
            background-color: var(--paper-bg);
            border: 1px solid #cfd8dc;
        }

        .front {
            z-index: 2; border-radius: 0 15px 15px 0;
            border-left: 2px solid #b0bec5;
            background: linear-gradient(to right, #f5f5f5 0%, var(--paper-bg) 10%, var(--paper-bg) 100%);
        }

        .back {
            transform: rotateY(180deg); z-index: 1;
            border-radius: 15px 0 0 15px;
            border-right: 2px solid #b0bec5;
            background: linear-gradient(to left, #f5f5f5 0%, var(--paper-bg) 10%, var(--paper-bg) 100%);
            box-shadow: inset -5px 0 15px rgba(0,0,0,0.03);
        }

        .no-border { border: none !important; background: none !important; }
        .page.flipped { transform: rotateY(-180deg); }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„ØºÙ„Ø§Ù --- */
        .cover-wrapper {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #00acc1 0%, #00838f 100%);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 20px; box-shadow: inset 10px 0 20px rgba(0,0,0,0.2);
            color: white;
            border-radius: 0 15px 15px 0;
        }

        .cover-img {
            width: 160px; height: 160px; object-fit: cover;
            border-radius: 10%; border: 6px solid #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .book-title-large {
            font-size: 3.5rem; font-weight: 900; margin-bottom: 30px;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
        }

        .cover-buttons { width: 70%; display: flex; flex-direction: column; gap: 15px; }

        .cover-btn {
            background: white; color: #00838f; border: none;
            padding: 15px; border-radius: 50px; font-size: 1.2rem; font-weight: 800;
            cursor: pointer; transition: 0.3s; box-shadow: 0 5px 0 #b2ebf2;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .cover-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 0 #b2ebf2; }
        .cover-btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-start { background: #ffd54f; color: #e65100; box-shadow: 0 5px 0 #ffca28; }
        .btn-start:hover { box-shadow: 0 8px 0 #ffca28; }

        /* --- ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© --- */
        .profile-page {
            width: 100%; height: 100%; background: #e0f2f1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-left: 3px dashed #80cbc4; padding: 20px;
        }
        .profile-card {
            background: white; padding: 30px; border-radius: 20%;
            width: 80%; text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 2px solid #b2dfdb;
        }
        .profile-img-placeholder {
            width: 140px; height: 140px; background: #fafafa;
            border: 5px solid #ffab91; border-radius: 50%;
            margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
            overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .profile-img-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        
        .profile-title { color: #f57f17; font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .profile-name { color: #006064; font-size: 1.6rem; font-weight: 900; line-height: 1.4; }

        /* --- ØµÙØ­Ø© Ø§Ù„ØªÙˆØµÙŠÙ --- */
        .desc-page {
            width: 100%; height: 100%; background: #fff3e0;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 30px; overflow-y: auto;
        }
        .desc-box {
            background: white; padding: 20px; border-radius: 20px;
            border: 3px solid #ffcc80; color: #e65100;
            font-size: 0.9rem; line-height: 1.6; font-weight: 600;
            box-shadow: 0 5px 0 #ffe0b2; width: 100%; text-align: right;
        }
        .desc-header {
            font-size: 1.4rem; font-weight: 900; color: #e65100; margin-bottom: 10px;
            text-align: center; border-bottom: 2px dashed #ffe0b2; padding-bottom: 5px;
        }
        .desc-section { margin-bottom: 8px; border-bottom: 1px solid #fff3e0; padding-bottom: 5px; }
        .desc-section:last-child { border-bottom: none; }
        .desc-key { color: #d84315; font-weight: 900; display: inline-block; min-width: 120px;}
        .desc-val { color: #37474f; font-weight: 600; }

        /* --- Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ --- */
        .text-container { padding: 2rem; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; }
        .text-box-styled { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); border: 3px dashed #4db6ac; position: relative; width: 90%; text-align: center;}
        .page-header { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: #ff7043; color: white; padding: 5px 25px; border-radius: 50px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 4px 0 #d84315; white-space: nowrap; }
        .text-content { font-size: 1.6rem; line-height: 1.7; color: #37474f; font-weight: 700; }

        .media-container { width: 90%; height: 90%; margin: 5%; background: #000; display: flex; justify-content: center; align-items: center; border-radius: 15px; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        .full-video { width: 100%; height: 100%; object-fit: cover; }
        .split-video-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; background: black; }
        .split-video-container { width: 200% !important; max-width: none !important; height: 100%; position: absolute; top: 0; object-fit: cover; pointer-events: none; }
        .rtl-left-page-video { left: 0; } .rtl-right-page-video { left: -100%; }

        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø³Ø¦Ù„Ø© (Modern Quiz) --- */
        .quiz-left { 
            width: 100%; height: 100%; 
            background: #e0f7fa; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            padding: 20px; border-left: 3px dashed #4dd0e1; 
            position: relative;
            overflow: hidden;
        }
        
        .quiz-right { 
            width: 100%; height: 100%; 
            background: #fff; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            padding: 25px; 
            background-image: radial-gradient(#e1f5fe 20%, transparent 20%);
            background-size: 20px 20px;
        }

        .question-bubble {
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 0 #0288d1;
            border: 3px solid #0288d1;
            width: 90%;
            position: relative;
            animation: float 3s ease-in-out infinite;
            z-index: 2;
        }
        
        .question-icon-circle {
            width: 80px; height: 80px;
            background: #ffd54f;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; color: #fff;
            position: absolute;
            top: -40px; left: 50%; transform: translateX(-50%);
            border: 4px solid white;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }

        .question-text {
            margin-top: 30px;
            font-size: 1.5rem;
            color: #0277bd;
            font-weight: 900;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            width: 100%;
        }

        .quiz-card-btn {
            background: white;
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 800;
            color: #546e7a;
            cursor: pointer;
            box-shadow: 0 6px 0 #eceff1;
            border: 2px solid #eceff1;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .quiz-card-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 0 #cfd8dc;
            border-color: #4dd0e1;
            color: #00838f;
        }

        .quiz-card-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cfd8dc;
        }

        .quiz-card-btn.correct {
            background: #c8e6c9;
            color: #2e7d32;
            border-color: #4caf50;
            box-shadow: 0 6px 0 #4caf50;
            animation: bounce 0.6s;
        }

        .quiz-card-btn.wrong {
            background: #ffcdd2;
            color: #c62828;
            border-color: #ef5350;
            box-shadow: 0 6px 0 #ef5350;
            animation: shake 0.5s;
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù„Ø¹Ø¨Ø© (Puzzle) --- */
        .game-header { background: #5c6bc0; color: white; padding: 8px 20px; border-radius: 20px; font-weight: 900; margin-bottom: 15px; display: inline-block; font-size: 1.1rem;}
        .game-page-left { width: 100%; height: 100%; background: #e8eaf6; border-left: 3px dashed #9fa8da; display: flex; flex-direction: column; align-items: center; padding: 15px; }
        .game-page-right { width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; }
        
        .drop-zones-grid { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; }
        .drop-zone { height: 80px; width: 100%; background: rgba(255,255,255,0.6); border: 2px dashed #7986cb; border-radius: 12px; display: flex; align-items: center; padding: 0 10px; gap: 10px; transition: 0.3s; }
        .drop-zone.filled { background: white; border: 2px solid #4caf50; padding: 0; overflow: hidden; }
        .drop-zone-num { width: 30px; height: 30px; background: #7986cb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .draggables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .draggable-item { width: 100%; aspect-ratio: 4/3; background: white; border: 4px solid white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: grab; overflow: hidden; transition: transform 0.2s; }
        .draggable-item:hover { transform: scale(1.05); z-index: 10; }
        .draggable-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .drag-ghost { position: fixed; z-index: 9999; width: 120px; height: 90px; border: 4px solid #ffd54f; border-radius: 12px; opacity: 0.9; pointer-events: none; }

        /* Ø±Ø³Ø§Ø¦Ù„ ÙˆÙ†Ù‚Ø§Ø· */
        .win-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; z-index: 10000; display: none; flex-direction: column; align-items: center; border: 6px solid #4caf50; animation: popIn 0.5s; }
        .game-score-fixed { position: fixed; top: 20px; left: 20px; background: white; padding: 8px 20px; border-radius: 30px; font-weight: bold; color: #f57f17; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 2000; border: 2px solid #fff9c4; display: flex; align-items: center; gap: 8px; }

        .controls-bar {
            position: fixed; bottom: 30px;
            background: rgba(255,255,255,0.95); padding: 10px 30px;
            border-radius: 50px; display: flex; gap: 20px; align-items: center; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 1000; border: 1px solid #b2dfdb;
        }
        .ctrl-btn { border: none; color: #fff; width: 50px; height: 50px; border-radius: 50%; font-size: 1.3rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 rgba(0,0,0,0.15); position: relative; top: 0; }
        .ctrl-btn:hover { transform: translateY(-3px); } .ctrl-btn:active { top: 2px; box-shadow: none; }
        .btn-next { background: #00acc1; } .btn-prev { background: #ff7043; } 
        .btn-play { background: #ffa726; } .btn-mute { background: #7e57c2; } 
        .page-num { color: #546e7a; font-family: 'Baloo Bhaijaan 2'; font-size: 1.2rem; font-weight: 800; background: #eceff1; padding: 5px 15px; border-radius: 15px; }

        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        @media (max-width: 768px) {
            :root { --book-w: 90vw; --book-h: 60vw; }
            .book-title-large { font-size: 2.5rem; }
            .cover-img { width: 120px; height: 120px; }
            .text-content { font-size: 1.2rem; line-height: 1.4; }
            .ctrl-btn { width: 40px; height: 40px; font-size: 1.1rem; }
            .draggable-item { height: 70px; } .drop-zone { height: 60px; font-size: 0.9rem; }
            .question-text { font-size: 1.2rem; }
            .quiz-card-btn { padding: 10px; font-size: 1rem; }
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="game-score-fixed">
        <i class="fas fa-star text-yellow-400"></i>
        <span id="globalScore">0</span>
    </div>

    <div class="stage">
        <div class="book" id="book"></div>
    </div>

    <div id="winMsg" class="win-msg">
        <div class="flex justify-center gap-2 mb-4">
            <i class="fas fa-star text-yellow-400 text-6xl fa-bounce"></i>
        </div>
        <h2 class="text-4xl font-bold text-green-600 mb-2 font-baloo">Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!</h2>
        <p class="text-gray-600 text-lg mb-6">Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­</p>
        <button onclick="location.reload()" class="bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
    </div>

    <audio id="sfxFlip" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>
    <audio id="sfxWin" src="sound/achivement.mp3"></audio>
    <audio id="sfxWrong" src="sound/wrong.mp3"></audio>
    <audio id="narratorAudio"></audio>

    <div class="controls-bar">
        <button class="ctrl-btn btn-next" onclick="nextPage()"><i class="fas fa-arrow-right"></i></button>
        <button class="ctrl-btn btn-play" onclick="togglePlayPause()" id="playPauseBtn"><i class="fas fa-play"></i></button>
        <button class="ctrl-btn btn-mute" onclick="toggleMute()" id="muteBtn"><i class="fas fa-volume-up"></i></button>
        <span class="page-num" id="pageIndicator">0 / 0</span>
        <button class="ctrl-btn btn-prev" onclick="prevPage()"><i class="fas fa-arrow-left"></i></button>
    </div>

    <script>
        window.handleVideoError = function(video) {
            video.parentElement.innerHTML = `<div class="flex flex-col items-center justify-center h-full bg-gray-100 text-gray-400"><i class="fas fa-video-slash text-2xl mb-2"></i><span class="text-xs">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹</span></div>`;
        };

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xb2dfdb);
            scene.fog = new THREE.Fog(0xb2dfdb, 40, 150);
            
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            const isMobile = window.innerWidth < 768;
            camera.position.set(0, isMobile ? 30 : 25, isMobile ? 40 : 35); 
            camera.lookAt(0, -2, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; 
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
            container.appendChild(renderer.domElement);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); 
            scene.add(ambientLight);
            const sunLight = new THREE.DirectionalLight(0xfff176, 0.8); 
            sunLight.position.set(50, 100, 50);
            sunLight.castShadow = true;
            scene.add(sunLight);
            
            const envGroup = new THREE.Group();
            const floorGeom = new THREE.PlaneGeometry(1000, 1000);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0xa5d6a7 });
            const floor = new THREE.Mesh(floorGeom, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -20;
            floor.receiveShadow = true;
            envGroup.add(floor);

            const tableGroup = new THREE.Group();
            const tableTopGeom = new THREE.BoxGeometry(110, 3, 70);
            const tableMat = new THREE.MeshStandardMaterial({ color: 0x8d6e63 }); 
            const tableTop = new THREE.Mesh(tableTopGeom, tableMat);
            tableTop.position.y = -6;
            tableTop.receiveShadow = true;
            tableTop.castShadow = true;
            tableGroup.add(tableTop);

            const legGeom = new THREE.CylinderGeometry(2, 2, 14, 16);
            const legMat = new THREE.MeshStandardMaterial({ color: 0x6d4c41 });
            [{x: -45, z: -25}, {x: 45, z: -25}, {x: -45, z: 25}, {x: 45, z: 25}].forEach(pos => {
                const leg = new THREE.Mesh(legGeom, legMat);
                leg.position.set(pos.x, -13, pos.z);
                leg.castShadow = true;
                leg.receiveShadow = true;
                tableGroup.add(leg);
            });
            envGroup.add(tableGroup);
            
            function addTree(x, z, scale = 1) {
                const trunkGeom = new THREE.CylinderGeometry(1*scale, 1.5*scale, 6*scale, 6);
                const trunkMat = new THREE.MeshStandardMaterial({ color: 0x795548 });
                const trunk = new THREE.Mesh(trunkGeom, trunkMat);
                trunk.position.set(x, -20 + (3*scale), z);
                const leavesGeom = new THREE.DodecahedronGeometry(5*scale);
                const leavesMat = new THREE.MeshStandardMaterial({ color: 0x43a047 });
                const leaves = new THREE.Mesh(leavesGeom, leavesMat);
                leaves.position.y = 5*scale;
                trunk.add(leaves);
                trunk.castShadow = true;
                envGroup.add(trunk);
            }

            for(let i=0; i<30; i++) {
                const x = (Math.random() - 0.5) * 250;
                const z = -70 - Math.random() * 80;
                addTree(x, z, 1.2 + Math.random());
            }
            addTree(-75, 0, 1.4);
            addTree(75, 10, 1.4);

            const flowerGeom = new THREE.SphereGeometry(0.6, 8, 8);
            const fColors = [0xffeb3b, 0xf44336, 0xff9800, 0xba68c8];
            for(let i=0; i<60; i++) {
                const col = fColors[Math.floor(Math.random()*fColors.length)];
                const mat = new THREE.MeshBasicMaterial({ color: col });
                const flower = new THREE.Mesh(flowerGeom, mat);
                flower.position.set((Math.random()-0.5)*180, -19.5, (Math.random()-0.5)*90 + 20);
                if(Math.abs(flower.position.x) > 60 || Math.abs(flower.position.z) > 40) envGroup.add(flower);
            }
            scene.add(envGroup);
            
            let mouseX = 0; let mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) - 0.5;
                mouseY = (event.clientY / window.innerHeight) - 0.5;
            });
            const animate = () => {
                requestAnimationFrame(animate);
                const factor = window.innerWidth < 768 ? 1 : 2; 
                camera.position.x += (mouseX * factor * 5 - camera.position.x) * 0.05;
                const targetY = (window.innerWidth < 768 ? 30 : 25) + mouseY * 5;
                camera.position.y += (targetY - camera.position.y) * 0.05;
                camera.lookAt(0, -2, 0);
                renderer.render(scene, camera);
            };
            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                const isMob = window.innerWidth < 768;
                camera.position.z = isMob ? 40 : 35;
                camera.position.y = isMob ? 30 : 25;
            });
        }
        initThreeJS();

        const assets = {
            images: { 
                // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù„ØµÙŠØºØ© Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹
                cover: 'https://lh3.googleusercontent.com/d/1OXpZE5sMqB8lC-v-cCMHbJQtso_LCyef', 
                profile: 'https://lh3.googleusercontent.com/d/1q0t3VCDOZLEF2hp51ZCt_44paCRjw7KH' 
            },
            video: {
                1: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/1_tzks3o',
                2: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/2_xknv7j',
                3: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/3_wo5zkq',
                4: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/4_myyjhn',
                5: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/5_wobned',
                6: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/6_r1jspr',
                7: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/7_celdbg',
                8: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/8_ncbije',
                9: 'https://res.cloudinary.com/dhvuw8yog/video/upload/v1/9_xz5bsb'
            },
            audio: {
                1: 'sound/1.mp3', 2: 'sound/2.mp3', 3: 'sound/3.mp3', 4: 'sound/4.mp3',
                5: 'sound/5.mp3', 6: 'sound/6.mp3', 7: 'sound/7.mp3', 8: 'sound/8.mp3', 9: 'sound/9.mp3'
            },
            gameImages: {
                1: 'game/1.jpg', 2: 'game/4.jpg', 3: 'game/7.jpg', 4: 'game/9.jpg'
            }
        };

        const storyConfig = [
            // Sheet 0: Cover / Personal Data
            { type: 'cover' }, // 0 Front
            { type: 'personal-data' }, // 0 Back
            
            // Sheet 1: Book Desc / Story Start
            { type: 'book-desc' }, // 1 Front
            { type: 'text', title: 'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ â˜€ï¸', text: 'Ø§Ø³ØªÙŠÙ‚Ø¸ Ø¥ÙŠÙ‡Ø§Ø¨ Ù…Ù† Ù†ÙˆÙ…Ù‡ØŒ ÙØªØ­ Ø¹ÙŠÙ†ÙŠÙ‡ ÙˆØªÙ…Ø·Ù‘Ù‰ Ù‚Ù„ÙŠÙ„Ù‹Ø§ØŒ ÙˆØ§Ø³ØªØ¹Ø¯ Ù„ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯.', id: 1 }, // 1 Back
            
            // Story
            { type: 'video', id: 1 }, 
            { type: 'text', title: 'ØºØ³Ù„ Ø§Ù„Ø£Ø³Ù†Ø§Ù† ğŸª¥', text: 'Ø¯Ø®Ù„ Ø§Ù„Ø­Ù…Ù‘Ø§Ù…ØŒ Ø£Ø®Ø° Ø§Ù„ÙØ±Ø´Ø§Ø© ÙˆØ§Ù„Ù…Ø¹Ø¬ÙˆÙ†ØŒ ÙˆÙ†Ø¸Ù‘Ù Ø£Ø³Ù†Ø§Ù†Ù‡ Ø¬ÙŠØ¯Ù‹Ø§ Ù„ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ø¨ØªØ³Ø§Ù…ØªÙ‡.', id: 2 }, 
            
            { type: 'video', id: 2 }, 
            { type: 'text', title: 'ØºØ³Ù„ Ø§Ù„ÙˆØ¬Ù‡ ğŸ’§', text: 'ØºØ³Ù„ Ø¥ÙŠÙ‡Ø§Ø¨ ÙˆØ¬Ù‡Ù‡ Ø¨Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø±Ø¯ØŒ ÙØ´Ø¹Ø± Ø¨Ø§Ù„Ø§Ù†ØªØ¹Ø§Ø´ØŒ Ø«Ù… Ø¬ÙÙ‘ÙÙ‡ Ø¨Ø§Ù„Ù…Ù†Ø´ÙØ©.', id: 3 }, 
            
            { type: 'video', id: 3 }, 
            { type: 'quiz-split', id: 1, side: 'left' }, 
            
            { type: 'quiz-split', id: 1, side: 'right' },
            { type: 'text', title: 'Ø±ÙƒÙˆØ¨ Ø§Ù„Ø¨Ø§Øµ ğŸšŒ', text: 'Ø§Ø±ØªØ¯Ù‰ Ù…Ù„Ø§Ø¨Ø³Ù‡ØŒ Ø­Ù…Ù„ Ø­Ù‚ÙŠØ¨ØªÙ‡ØŒ ÙˆØµØ¹Ø¯ Ø§Ù„Ø¨Ø§Øµ Ù…ØªØ¬Ù‡Ù‹Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆÙ‡Ùˆ ÙŠÙ†Ø¸Ø± Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©.', id: 4 }, 
            
            { type: 'video', id: 4 }, 
            { type: 'video-split', id: 5, side: 'left' },  
            
            { type: 'video-split', id: 5, side: 'right' }, 
            { type: 'quiz-split', id: 2, side: 'left' }, 
            
            { type: 'quiz-split', id: 2, side: 'right' },
            { type: 'text', title: 'Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ù… â¤ï¸', text: 'Ø¹Ø§Ø¯ Ù„Ù„Ø¨ÙŠØª Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©ØŒ ØºØ³Ù„ ÙŠØ¯ÙŠÙ‡ØŒ ÙˆØ³Ø§Ø¹Ø¯ Ø£Ù…Ù‡ ÙÙŠ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©.', id: 6 }, 
            
            { type: 'video', id: 6 }, 
            { type: 'text', title: 'Ø§Ù„ØºØ¯Ø§Ø¡ ğŸ', text: 'Ø¬Ù„Ø³ Ù…Ø¹ Ø¹Ø§Ø¦Ù„ØªÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©ØŒ ÙˆØªÙ†Ø§ÙˆÙ„ÙˆØ§ Ø§Ù„ØºØ¯Ø§Ø¡ Ù…Ø¹Ù‹Ø§ ÙÙŠ Ø¬Ùˆ Ù‡Ø§Ø¯Ø¦.', id: 7 }, 
            
            { type: 'video', id: 7 }, 
            { type: 'quiz-split', id: 3, side: 'left' }, 
            
            { type: 'quiz-split', id: 3, side: 'right' },
            { type: 'text', title: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ğŸ“š', text: 'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡ØŒ Ø¬Ù„Ø³ Ù…Ø¹ Ø¥Ø®ÙˆØªÙ‡ ÙŠÙ‚Ø±Ø¤ÙˆÙ† ÙƒØªØ§Ø¨Ù‹Ø§ Ù…Ù…ØªØ¹Ù‹Ø§ Ù…Ù„ÙŠØ¦Ù‹Ø§ Ø¨Ø§Ù„ØµÙˆØ±.', id: 8 }, 
            
            { type: 'video', id: 8 }, 
            { type: 'text', title: 'Ø§Ù„Ù†ÙˆÙ… ğŸŒ™', text: 'Ù…Ø¹ Ø§Ù„Ù„ÙŠÙ„ØŒ Ø´Ø¹Ø± Ø¨Ø§Ù„Ù†Ø¹Ø§Ø³ØŒ Ø±ØªØ¨ Ø³Ø±ÙŠØ±Ù‡ØŒ ÙˆÙ†Ø§Ù… ÙˆÙ‡Ùˆ Ø³Ø¹ÙŠØ¯ Ø¨ÙŠÙˆÙ…Ù‡.', id: 9 }, 
            
            { type: 'video', id: 9 }, 
            
            { type: 'game-level', level: 1, side: 'left' }, { type: 'game-level', level: 1, side: 'right' },
            { type: 'game-level', level: 2, side: 'left' }, { type: 'game-level', level: 2, side: 'right' },
            { type: 'game-level', level: 3, side: 'left' }, { type: 'game-level', level: 3, side: 'right' },
            
            { type: 'back-cover' } 
        ];

        const quizData = [
            { id: 1, icon: "fa-question", question: "Ù…Ø§Ø°Ø§ ÙØ¹Ù„ Ø¥ÙŠÙ‡Ø§Ø¨ Ø£ÙˆÙ„ Ù…Ø§ Ø§Ø³ØªÙŠÙ‚Ø¸ØŸ", options: ["Ø´Ø§Ù‡Ø¯ Ø§Ù„ØªÙ„ÙØ§Ø²", "ØªÙ…Ø·Ù‘Ù‰ ÙˆØ§Ø³ØªØ¹Ø¯ Ù„Ù„ÙŠÙˆÙ…", "Ø£ÙƒÙ„ Ø§Ù„ØºØ¯Ø§Ø¡"], correct: 1 },
            { id: 2, icon: "fa-bus", question: "ÙƒÙŠÙ Ø°Ù‡Ø¨ Ø¥ÙŠÙ‡Ø§Ø¨ Ù„Ù„Ù…Ø¯Ø±Ø³Ø©ØŸ", options: ["Ø¨Ø§Ù„Ø¨Ø§Øµ", "Ù…Ø´ÙŠØ§Ù‹", "Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©"], correct: 0 },
            { id: 3, icon: "fa-utensils", question: "Ù…Ø§Ø°Ø§ ÙØ¹Ù„ Ø¥ÙŠÙ‡Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©ØŸ", options: ["Ù„Ø¹Ø¨ Ø¨Ø§Ù„ÙƒØ±Ø©", "Ø³Ø§Ø¹Ø¯ Ø£Ù…Ù‡", "Ù†Ø§Ù… ÙÙˆØ±Ø§Ù‹"], correct: 1 }
        ];

        let currentPage = 0; 
        let isPlaying = false; 
        let globalScore = 0;
        let currentLevelProgress = 0;
        let draggedEl = null; let ghostEl = null; let dragSrcId = null;
        let syncTimer = null; // FIXED: Added syncTimer

        // Navigation
        function goToPage(pageIndex) {
            // Activate play mode if jumping from cover
            if (pageIndex > 1) { 
                isPlaying = true; 
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
            }
            const targetSheet = pageIndex; 
            const interval = setInterval(() => {
                if(currentPage < targetSheet) nextPage();
                else if(currentPage > targetSheet) prevPage();
                else clearInterval(interval);
            }, 300);
        }

        function playNarration(id) {
            const narrator = document.getElementById('narratorAudio');
            if (assets.audio[id]) { 
                narrator.src = assets.audio[id]; 
                narrator.currentTime = 0;
                narrator.play().catch(e => {}); 
            } else { 
                narrator.pause(); 
            }
        }

        function stopAllMedia() {
            const narrator = document.getElementById('narratorAudio');
            narrator.pause();
            narrator.currentTime = 0;

            document.querySelectorAll('video').forEach(v => {
                v.pause();
                // We reset ALL videos now to be safe, standard videos will restart, split videos will resume/restart cleanly
                if(!v.classList.contains('split-video-container')) {
                    v.currentTime = 0;
                }
            });
        }

        function handleQuizAnswer(btn, isCorrect) {
            if (btn.classList.contains('clicked')) return;
            btn.classList.add('clicked');
            const allBtns = btn.parentElement.querySelectorAll('.quiz-card-btn');
            allBtns.forEach(b => b.classList.add('clicked')); 
            if (isCorrect) {
                btn.classList.add('correct');
                btn.innerHTML += ' <i class="fas fa-check-circle text-green-700"></i>';
                document.getElementById('sfxWin').play().catch(()=>{});
                globalScore += 20; document.getElementById('globalScore').innerText = globalScore;
            } else {
                btn.classList.add('wrong');
                btn.innerHTML += ' <i class="fas fa-times-circle text-red-700"></i>';
                document.getElementById('sfxWrong').play().catch(()=>{});
                const correctBtn = Array.from(allBtns).find(b => b.dataset.correct === "true");
                if(correctBtn) {
                    correctBtn.classList.add('correct');
                    correctBtn.innerHTML += ' <i class="fas fa-check-circle text-green-700"></i>';
                }
            }
        }

        const gameLevels = [
            { level: 1, title: "Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…", zones: [{id: 1, label: "Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸"}, {id: 4, label: "Ø§Ù„Ù†ÙˆÙ…"}], items: [{id: 4, img: "game/9.jpg"}, {id: 1, img: "game/1.jpg"}] },
            { level: 2, title: "Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", zones: [{id: 1, label: "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"}, {id: 2, label: "Ø§Ù„ØºØ¯Ø§Ø¡"}, {id: 3, label: "Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"}], items: [{id: 3, img: "game/8.jpg"}, {id: 1, img: "game/4.jpg"}, {id: 2, img: "game/7.jpg"}] },
            { level: 3, title: "Ø±ØªØ¨ Ø§Ù„ÙŠÙˆÙ… ÙƒØ§Ù…Ù„Ø§Ù‹", zones: [{id: 1, label: "Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸"}, {id: 2, label: "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"}, {id: 3, label: "Ø§Ù„ØºØ¯Ø§Ø¡"}, {id: 4, label: "Ø§Ù„Ù†ÙˆÙ…"}], items: [{id: 3, img: "game/7.jpg"}, {id: 1, img: "game/1.jpg"}, {id: 4, img: "game/9.jpg"}, {id: 2, img: "game/4.jpg"}] }
        ];

        function handleDragStart(e, id, imgUrl) {
            e.preventDefault(); dragSrcId = id;
            ghostEl = document.createElement('img'); ghostEl.src = decodeURI(imgUrl); ghostEl.className = 'drag-ghost'; document.body.appendChild(ghostEl);
            moveGhost(e);
            e.target.closest('.draggable-item').style.opacity = '0.3'; draggedEl = e.target.closest('.draggable-item');
            document.addEventListener('mousemove', moveGhost); document.addEventListener('mouseup', handleDrop);
            document.addEventListener('touchmove', moveGhost, {passive: false}); document.addEventListener('touchend', handleDrop);
        }

        function moveGhost(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            if(ghostEl) { ghostEl.style.left = (clientX - 60) + 'px'; ghostEl.style.top = (clientY - 45) + 'px'; }
        }

        function handleDrop(e) {
            document.removeEventListener('mousemove', moveGhost); document.removeEventListener('mouseup', handleDrop);
            document.removeEventListener('touchmove', moveGhost); document.removeEventListener('touchend', handleDrop);
            
            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            
            if(ghostEl) ghostEl.style.display = 'none';
            let elemBelow = document.elementFromPoint(clientX, clientY);
            if(ghostEl) ghostEl.remove();
            
            let dropZone = elemBelow ? elemBelow.closest('.drop-zone') : null;

            if (dropZone && !dropZone.classList.contains('filled')) {
                const zoneId = parseInt(dropZone.dataset.id);
                const levelIdx = parseInt(dropZone.dataset.levelIdx);

                if (zoneId === dragSrcId) {
                    dropZone.classList.add('filled');
                    dropZone.innerHTML = `<img src="${draggedEl.querySelector('img').src}" style="width:100%; height:100%; object-fit:cover;">`;
                    draggedEl.remove();
                    
                    document.getElementById('sfxWin').play().catch(()=>{});
                    globalScore += 10; document.getElementById('globalScore').innerText = globalScore;
                    currentLevelProgress++;
                    
                    if(currentLevelProgress === gameLevels[levelIdx].items.length) {
                        setTimeout(() => {
                            if (levelIdx < 2) {
                                nextPage(); // Auto advance
                            } else {
                                document.getElementById('winMsg').style.display = 'flex';
                            }
                        }, 1500); 
                    }
                } else {
                    draggedEl.style.opacity = '1';
                    document.getElementById('sfxWrong').play().catch(()=>{});
                }
            } else { if(draggedEl) draggedEl.style.opacity = '1'; }
            draggedEl = null; ghostEl = null;
        }

        function initBook() {
            const bookEl = document.getElementById('book');
            bookEl.innerHTML = '';
            const numSheets = Math.ceil(storyConfig.length / 2);
            for (let i = 0; i < numSheets; i++) {
                const dataFront = storyConfig[i * 2];
                const dataBack = storyConfig[i * 2 + 1];
                const pageDiv = document.createElement('div');
                pageDiv.className = `page`;
                pageDiv.id = `page-${i}`;
                pageDiv.style.zIndex = numSheets - i; 
                let frontHTML = generateFaceHTML(dataFront, 'front', i);
                let frontClass = 'front';
                if(dataFront && (dataFront.type === 'video-split' || dataFront.type === 'game-level' || dataFront.type === 'quiz-split' || dataFront.type === 'personal-data' || dataFront.type === 'book-desc')) frontClass += ' no-border';
                let backHTML = generateFaceHTML(dataBack, 'back', i);
                let backClass = 'back';
                if(dataBack && (dataBack.type === 'video-split' || dataBack.type === 'game-level' || dataBack.type === 'quiz-split' || (dataBack && dataBack.type === 'personal-data'))) backClass += ' no-border';
                pageDiv.innerHTML = `<div class="${frontClass}">${frontHTML}</div><div class="${backClass}">${backHTML}</div>`;
                bookEl.appendChild(pageDiv);
            }
        }

        function generateFaceHTML(data, faceType, sheetIndex) {
            if (!data) return `<div class="text-container"></div>`;
            
            if (data.type === 'cover') {
                return `
                <div class="cover-wrapper">
                    <img src="${assets.images.cover}" class="cover-img" onerror="this.src='https://via.placeholder.com/150/00838f/ffffff?text=ÙŠÙˆÙ…ÙŠØ§Øª+Ø¥ÙŠÙ‡Ø§Ø¨'">
                    <h1 class="book-title-large">ÙŠÙˆÙ…ÙŠØ§Øª Ø¥ÙŠÙ‡Ø§Ø¨</h1>
                    <div class="cover-buttons">
                        <button class="cover-btn" onclick="goToPage(1)">
                            <i class="fas fa-id-card"></i> Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
                        </button>
                        <button class="cover-btn" onclick="goToPage(1)">
                            <i class="fas fa-book-open"></i> Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨
                        </button>
                        <button class="cover-btn btn-start" onclick="goToPage(2)">
                            <i class="fas fa-play"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚ØµØ©
                        </button>
                    </div>
                </div>`;
            }
            else if (data.type === 'personal-data') {
                return `
                <div class="profile-page">
                    <div class="profile-card">
                        <div class="profile-img-placeholder">
                            <img src="${assets.images.profile}" onerror="this.src='https://via.placeholder.com/150/ffab91/000000?text=ØµÙˆØ±Ø©+Ø§Ù„Ø·Ø§Ù„Ø¨Ø©'">
                        </div>
                        <div class="profile-title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</div>
                        <div class="profile-name">Ø³Ø§Ø±Ø© Ø¹Ø¨Ø¯ Ø§Ù„ÙˆÙ‡Ø§Ø¨<br>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯</div>
                        <div class="mt-4 text-gray-400 text-sm font-bold">
                            ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ±Ø¨ÙŠØ© Ù„Ù„Ø·ÙÙˆÙ„Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©<br>
                            Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
                        </div>

                        <div class="mt-6 text-right text-sm font-bold space-y-1" dir="rtl">
                            <div>Ø§Ù„Ø§Ø³Ù… : 
                                <span class="text-gray-500 font-normal mr-2">Ø³Ø§Ø±Ø© Ø¹Ø¨Ø¯Ø§Ù„ÙˆÙ‡Ø§Ø¨ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯</span>
                            </div>
                            <div>Ø§Ù„ÙØ±Ù‚Ø© : 
                                <span class="text-gray-500 font-normal mr-2">Ø§Ù„Ø«Ø§Ù„Ø«Ø©</span>
                            </div>
                            <div>Ø§Ù„Ø´Ø¹Ø¨Ø© : 
                                <span class="text-gray-500 font-normal mr-2">3</span>
                            </div>
                            <div>Ø§Ù„Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø¹Ø¨Ø© :
                                <span class="text-gray-500 font-normal mr-2">5</span>
                            </div>
                            <div class="bg-yellow-50 p-1 rounded">Ø§Ù„Ù…Ù‚Ø±Ø± :
                                <span class="text-gray-700 font-normal mr-2">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</span>
                            </div>
                            <div class="bg-yellow-50 p-1 rounded">Ø§Ù„ÙƒÙˆØ¯ :
                                <span class="text-gray-700 font-normal mr-2">M75031</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            if (data.type === 'book-desc') {
                return `
                <div class="desc-page">
                    <div class="desc-box">
                        <h2 class="desc-header">Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨</h2>
                        <div class="mb-4">
                            <span class="desc-key">Ø§Ù„ÙˆØµÙ:</span>
                            <span class="desc-val">ÙƒØªØ§Ø¨ ØªÙØ§Ø¹Ù„ÙŠ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙŠÙ‡Ø¯Ù Ø¥Ù„Ù‰ ØªÙ†Ù…ÙŠØ© Ø§Ù„ÙˆØ¹ÙŠ Ø¨Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£Ø·ÙØ§Ù„ Ù…Ù† Ø®Ù„Ø§Ù„ Ù‚ØµØ© Ù…Ù…ØªØ¹Ø©.</span>
                        </div>
                         <div class="mb-4">
                            <span class="desc-key">Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</span>
                            <span class="desc-val">Ù‚ØµØ© Ù…ØµÙˆØ±Ø© ÙˆÙ…Ø³Ù…ÙˆØ¹Ø©ØŒ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©ØŒ Ø£Ù„Ø¹Ø§Ø¨ ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù…ØªØ¹Ø©.</span>
                        </div>

                        <div class="desc-section">
                            <span class="desc-key">Ø§Ù„ØªÙˆØµÙŠÙ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ:</span>
                            <span class="desc-val">Ø¹Ø±Ø¶ ÙØ±Ø¯ÙŠ Ø£Ùˆ Ø¨Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„ÙˆØ§Ù„Ø¯.</span>
                        </div>
                        <div class="desc-section">
                            <span class="desc-key">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©:</span>
                            <span class="desc-val">5 - 6 Ø³Ù†ÙˆØ§Øª.</span>
                        </div>
                         <div class="desc-section">
                            <span class="desc-key">Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù†Ù…Ø§Ø¦ÙŠØ©:</span>
                            <span class="desc-val">Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ØŒ Ø§Ù„ØªÙ†Ø¸ÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠØŒ Ø§Ù„ÙˆØ¹ÙŠ Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØŒ Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù„ØºÙˆÙŠ.</span>
                        </div>
                        <div class="desc-section">
                            <span class="desc-key">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ±Ø¨ÙˆÙŠ:</span>
                            <span class="desc-val">ØªÙ†Ù…ÙŠØ© Ø§Ù„ÙˆØ¹ÙŠ Ø¨Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© + ØªØ¹Ø²ÙŠØ² Ù…Ù‡Ø§Ø±Ø© Ø§Ù„ÙÙ‡Ù… Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠ.</span>
                        </div>
                        <div class="desc-section">
                            <span class="desc-key">Ø§Ù„ØªÙØ§Ø¹Ù„:</span>
                            <span class="desc-val">Ø£Ø²Ø±Ø§Ø± ØªÙ†Ù‚Ù„ØŒ Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ØŒ Ù„Ø¹Ø¨Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«.</span>
                        </div>
                         <div class="desc-section">
                            <span class="desc-key">Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©:</span>
                            <span class="desc-val">"Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!"ØŒ Ù…Ø¤Ø«Ø±Ø§Øª ØµÙˆØªÙŠØ©.</span>
                        </div>
                         <div class="desc-section">
                            <span class="desc-key">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·:</span>
                            <span class="desc-val">ØµÙˆØ± â€“ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª â€“ Ù…Ø¤Ø«Ø±Ø§Øª ØµÙˆØªÙŠØ© â€“ ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ.</span>
                        </div>

                              <div class="desc-section">
                                <span class="desc-key">Ø§Ù„Ø§Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:</span><br>
                                <span class="desc-val">
                            JavaScript - Gemini ai - meta ai - lahajati ai

                                  
                                  </span>
                            </div>

                         <div class="desc-section">
                            <span class="desc-key">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·:</span>
                            <span class="desc-val">ØµÙˆØ± â€“ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª â€“ Ù…Ø¤Ø«Ø±Ø§Øª ØµÙˆØªÙŠØ© â€“ ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ.</span>
                        </div>
                    </div>

                    
                </div>`;
            }

            if (data.type === 'text') {
                return `
                <div class="text-container">
                    <div class="text-box-styled">
                        <div class="page-header">${data.title}</div>
                        <p class="text-content">"${data.text}"</p>
                    </div>
                </div>`;
            }

            if (data.type === 'video') {
                // FIXED: Standardized ID naming
                const vidId = `video-${sheetIndex}-${faceType}`;
                return `
                <div class="media-container">
                    <video id="${vidId}" class="full-video" src="${assets.video[data.id]}" playsinline loop muted onerror="window.handleVideoError(this)"></video>
                    <div class="absolute bottom-4 right-4 bg-white/80 p-2 rounded-full cursor-pointer hover:bg-white" onclick="document.getElementById('${vidId}').muted = !document.getElementById('${vidId}').muted">
                       <i class="fas fa-volume-mute text-xl text-teal-800"></i>
                    </div>
                </div>`;
            }

            if (data.type === 'video-split') {
                const vidId = `video-${sheetIndex}-${faceType}`;
                const splitClass = data.side === 'right' ? 'rtl-right-page-video' : 'rtl-left-page-video';
                return `
                <div class="split-video-wrapper">
                    <video id="${vidId}" class="split-video-container ${splitClass}" src="${assets.video[data.id]}" playsinline loop muted></video>
                </div>`;
            }

            if (data.type === 'quiz-split') {
                const q = quizData.find(q => q.id === data.id);
                if (data.side === 'left') {
                    // NEW DESIGN: Question Bubble
                    return `
                    <div class="quiz-left">
                        <div class="question-bubble">
                            <div class="question-icon-circle">
                                <i class="fas ${q.icon}"></i>
                            </div>
                            <h3 class="question-text">${q.question}</h3>
                        </div>
                        <i class="fas fa-shapes absolute bottom-10 left-10 text-6xl text-cyan-200 opacity-50 fa-spin" style="animation-duration: 10s;"></i>
                        <i class="fas fa-star absolute top-10 right-10 text-4xl text-yellow-300 opacity-60"></i>
                    </div>`;
                } else {
                    // NEW DESIGN: Cards
                    const optionsHTML = q.options.map((opt, idx) => {
                        const isCorrect = idx === q.correct;
                        return `<button class="quiz-card-btn" data-correct="${isCorrect}" onclick="handleQuizAnswer(this, ${isCorrect})">
                                    <span>${opt}</span>
                                    <i class="fas fa-hand-pointer opacity-20"></i>
                                </button>`;
                    }).join('');
                    return `<div class="quiz-right">
                                <h4 class="mb-6 text-xl text-gray-400 font-bold">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</h4>
                                <div class="options-grid">${optionsHTML}</div>
                            </div>`;
                }
            }

            if (data.type === 'game-level') {
                const levelIdx = data.level - 1; 
                const levelData = gameLevels[levelIdx];
                
                if (data.side === 'left') {
                    let zonesHTML = levelData.zones.map((z, idx) => `
                        <div class="drop-zone" data-id="${z.id}" data-level-idx="${levelIdx}">
                            <div class="drop-zone-num">${idx+1}</div>
                            <div class="drop-zone-text">${z.label}</div>
                        </div>`).join('');
                    return `
                    <div class="game-page-left">
                        <div class="game-header">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${data.level}</div>
                        <div class="drop-zones-grid">${zonesHTML}</div>
                    </div>`;
                } else {
                    let itemsHTML = levelData.items.map(item => `
                        <div class="draggable-item" onmousedown="handleDragStart(event, ${item.id}, '${encodeURI(item.img)}')" ontouchstart="handleDragStart(event, ${item.id}, '${encodeURI(item.img)}')">
                            <img src="${item.img}">
                        </div>`).join('');
                    return `
                    <div class="game-page-right">
                        <div class="draggables-grid">${itemsHTML}</div>
                        <p class="mt-4 text-gray-500 font-bold text-sm">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­</p>
                    </div>`;
                }
            }

            if (data.type === 'back-cover') {
                return `<div class="text-container"><h1 class="text-4xl font-bold text-teal-700">Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</h1></div>`;
            }

            return '';
        }

        // Navigation Logic
        function nextPage() {
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            if (!isPlaying) {
                isPlaying = true;
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
            }

            const numSheets = document.querySelectorAll('.page').length;
            if (currentPage < numSheets) { 
                currentPage++; 
                updateBook();
            }
        }
        function prevPage() { 
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            if (!isPlaying) {
                isPlaying = true;
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
            }

            if (currentPage > 0) { 
                currentPage--; 
                updateBook(); 
            } 
        }
        function togglePlayPause() { 
            isPlaying = !isPlaying; 
            document.getElementById('playPauseBtn').innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; 
            if (!isPlaying) stopAllMedia();
            updateBook(); 
        }
        function toggleMute() { 
            const narrator = document.getElementById('narratorAudio');
            narrator.muted = !narrator.muted; 
            document.getElementById('muteBtn').innerHTML = narrator.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>'; 
        }

        function updateBook() {
            // FIXED: Clear pending play commands immediately
            clearTimeout(syncTimer);

            const pages = document.querySelectorAll('.page');
            const numSheets = pages.length;
            document.getElementById('pageIndicator').innerText = `${currentPage} / ${numSheets}`;
            document.getElementById('sfxFlip').currentTime=0; document.getElementById('sfxFlip').play().catch(()=>{});

            // 1. Flip Animation
            pages.forEach((p, index) => {
                if (index < currentPage) {
                    if (!p.classList.contains('flipped')) { p.classList.add('flipped'); p.style.zIndex = index; }
                } else {
                    if (p.classList.contains('flipped')) { p.classList.remove('flipped'); p.style.zIndex = numSheets - index; }
                }
            });

            // 2. FORCE STOP ALL MEDIA FIRST
            stopAllMedia();

            if (!isPlaying) return;

            // 3. Determine Active Pages
            const leftSheetIdx = currentPage - 1;
            const rightSheetIdx = currentPage;

            // --- Handle Left Page (Back of previous sheet) ---
            if (leftSheetIdx >= 0) {
                const backData = storyConfig[leftSheetIdx * 2 + 1]; // Odd index in config
                
                // Play Audio
                if (backData && backData.type === 'text' && backData.id) playNarration(backData.id);
                
                // Play Video
                const vidId = `video-${leftSheetIdx}-back`;
                const v = document.getElementById(vidId);
                if (v) {
                    if(backData.type === 'video-split') v.muted = true; else v.muted = false;
                    v.play().catch(e => console.log("Auto-play prevented", e));
                }
            }

            // --- Handle Right Page (Front of current sheet) ---
            if (rightSheetIdx < numSheets) {
                const frontData = storyConfig[rightSheetIdx * 2]; // Even index in config
                
                // Play Audio
                if (frontData && frontData.type === 'text' && frontData.id) playNarration(frontData.id);
                
                // Play Video
                const vidId = `video-${rightSheetIdx}-front`;
                const v = document.getElementById(vidId);
                if (v) {
                    v.muted = false; 
                    v.play().catch(e => console.log("Auto-play prevented", e));
                }

                // Reset Game Logic
                if (frontData && frontData.type === 'game-level') currentLevelProgress = 0;
            }

            // 4. Sync Split Videos specifically (FIXED LOGIC)
            syncTimer = setTimeout(() => {
                // Find ONLY videos that belong to the currently visible pages
                const leftId = `video-${leftSheetIdx}-back`;
                const rightId = `video-${rightSheetIdx}-front`;
                
                const leftVideo = document.getElementById(leftId);
                const rightVideo = document.getElementById(rightId);

                // Check if they are actually split videos
                const isLeftSplit = leftVideo && leftVideo.classList.contains('split-video-container');
                const isRightSplit = rightVideo && rightVideo.classList.contains('split-video-container');

                if (isLeftSplit && isRightSplit) {
                     leftVideo.play().catch(()=>{});
                     rightVideo.play().catch(()=>{});
                }
            }, 600);
        }

        initBook();
        document.addEventListener('keydown', (e) => { if (e.key === 'ArrowRight') prevPage(); if (e.key === 'ArrowLeft') nextPage(); if (e.key === ' ') togglePlayPause(); });
    </script>
</body>
</html>